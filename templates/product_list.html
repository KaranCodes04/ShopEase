{% extends "base.html" %}
{% load static %}

{% block title %}All Products{% endblock %}

{% block content %}
<div class="text-center mb-4">
  <h1 class="fw-bold" style="color:#5a189a;">Welcome to ShopEase</h1>
  <p class="text-muted">Your one-stop destination for all products</p>
</div>

<h2 class="text-center mb-4">Our Products</h2>

<div class="row justify-content-center">
  {% for p in products %}
  <div class="col-md-3 col-sm-6 mb-4">
    <div class="card h-100 shadow-sm text-center">
      {% if p.image %}
        <img src="{{ p.image.url }}" class="card-img-top" style="height:220px;object-fit:contain;" alt="{{ p.name }}">
      {% endif %}
      <div class="card-body">
        <h5 class="card-title">{{ p.name }}</h5>
        <p class="text-muted">{{ p.description|truncatechars:80 }}</p>
        <h6 class="text-success mb-3">₹{{ p.price }}</h6>

        <!-- Use the simple GET endpoint that calls /cart/add/<id>/ -->
        <button type="button"
                class="btn btn-purple add-to-cart-btn"
                data-add-url="{% url 'store:add_to_cart' p.id %}"
                data-product-name="{{ p.name|escape }}">
          Add to Cart
        </button>
      </div>
    </div>
  </div>
  {% empty %}
  <p class="text-center">No products available.</p>
  {% endfor %}
</div>

<!-- Toast Container -->
<div id="toast-container" style="
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 9999;
"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const buttons = document.querySelectorAll('.add-to-cart-btn');
  const toastContainer = document.getElementById('toast-container');
  // find navbar cart link (works when link text contains 'Cart')
  const cartLink = Array.from(document.querySelectorAll('a.nav-link')).find(a => /cart/i.test(a.textContent));

  function showToast(message, success=true) {
    const toast = document.createElement('div');
    toast.classList.add('toast-msg');
    toast.innerText = message;
    toast.style.background = success ? '#5a189a' : '#d9534f';
    toast.style.color = '#fff';
    toast.style.padding = '10px 16px';
    toast.style.borderRadius = '8px';
    toast.style.marginTop = '10px';
    toast.style.boxShadow = '0 6px 18px rgba(0,0,0,0.12)';
    toast.style.opacity = '0';
    toast.style.transition = 'opacity 0.25s ease';
    toastContainer.appendChild(toast);
    setTimeout(()=> toast.style.opacity = '1', 50);
    setTimeout(()=> { toast.style.opacity = '0'; setTimeout(()=> toast.remove(),300); }, 2600);
  }

  buttons.forEach(button => {
    button.addEventListener('click', () => {
      const url = button.dataset.addUrl;
      const productName = button.dataset.productName || 'Product';

      // simple GET to add item (backend should accept GET on this URL)
      fetch(url, {
        method: 'GET',
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      })
      .then(async response => {
        if (!response.ok) {
          // try to read possible JSON error
          try {
            const j = await response.json();
            showToast(j.message || j.error || 'Could not add to cart', false);
          } catch(e) {
            showToast('Something went wrong', false);
          }
          return;
        }

        // success: some add endpoints redirect; treat 200/302 as success
        showToast(`${productName} added to cart!`, true);

        // Update cart link count if possible (try to parse number, else increment)
        if (cartLink) {
          const match = cartLink.textContent.match(/\((\d+)\)/);
          if (match) {
            const current = parseInt(match[1]);
            cartLink.textContent = cartLink.textContent.replace(/\(\d+\)/, `(${current + 1})`);
          } else {
            // if link has no count, append (1)
            cartLink.textContent = cartLink.textContent.trim() + ' (1)';
          }
        }
      })
      .catch(err => {
        console.error(err);
        showToast('Network error — try again', false);
      });
    });
  });
});
</script>
{% endblock %}


